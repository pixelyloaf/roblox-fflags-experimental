name: Build and Publish Retype-powered Electron App

on:
  push:
    branches:
      - main  # Run this workflow when changes are pushed to the main branch
  workflow_dispatch:  # Allows you to manually trigger this workflow from GitHub's UI

jobs:
  build_retype_site:
    name: Build Retype-powered website
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up .NET
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: 7.0.x

      - name: Build the Retype website
        uses: retypeapp/action-build@latest

      - name: Push Retype site to retype branch
        run: |
          git checkout -b retype
          git add .  # Add all the generated Retype files
          git commit -m "Build Retype-powered website"
          git push origin retype

  build_electron_app:
    name: Build and Package Electron App
    runs-on: ubuntu-latest
    needs: build_retype_site  # Ensure Retype site build is completed first

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16'

      - name: Install dependencies
        run: npm install

      - name: Build the Electron app
        run: npm run build
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

      - name: Package the Electron app
        run: npm run package

      - name: Verify the packaged files
        run: ls -la fastflags logs help resources assets  # List contents of directories

      - name: Create a new branch for Electron build artifacts
        run: |
          git checkout -b build-artifacts
          git add fastflags/**/* logs/**/* help/**/* resources/**/* assets/**/*  # Recursively add files in subdirectories
          git commit -m "Add Electron build artifacts"
          git push origin build-artifacts

      - name: Create a Pull Request for the Electron build
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "New Electron Build"
          body: "This PR contains the newly built Electron app."
          base: main
          head: build-artifacts
